<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç…å…ˆç”Ÿ_é«”è‚²èª² (å¼·åˆ¶å¤§é™¸æ™®é€šè©±ç‰ˆ)</title>
    <style>
        /* --- ğŸ¨ æ ¸å¿ƒè®Šæ•¸ --- */
        :root {
            --primary: #6366f1; --bg-grad: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --glass: rgba(255, 255, 255, 0.95); --text-main: #1f2937; --font-main: "Microsoft JhengHei", "PingFang SC", sans-serif;
        }
        body.theme-kids { --bg-grad: linear-gradient(120deg, #f6d365 0%, #fda085 100%); --primary: #ff6b6b; }
        body.theme-junior { --bg-grad: linear-gradient(120deg, #89f7fe 0%, #66a6ff 100%); --primary: #0984e3; }
        body.theme-teen { --bg-grad: linear-gradient(120deg, #2b32b2 0%, #1488cc 100%); --primary: #00cec9; --text-main: #f3f4f6; }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--font-main); user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-grad); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* ğŸ”´ ç‹€æ…‹é¡¯ç¤ºæ¢ */
        #status-bar {
            background: #ef4444; color: white; font-size: 0.8rem; padding: 8px; text-align: center;
            font-weight: bold; width: 100%; z-index: 2000;
        }

        /* å°èˆªèˆ‡ä½ˆå±€ */
        .navbar { padding: 10px 20px; background: rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .nav-btn { background: rgba(255,255,255,0.3); border: 1px solid white; padding: 5px 15px; border-radius: 20px; cursor: pointer; }
        .layout { display: flex; flex: 1; height: 100%; overflow: hidden; gap: 20px; padding: 20px; }
        .panel { background: var(--glass); border-radius: 20px; padding: 20px; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .sidebar { width: 320px; display: flex; flex-direction: column; gap: 10px; }
        .main-stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .queue-panel { width: 250px; }
        
        /* å…ƒä»¶æ¨£å¼ */
        select, input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc; margin-bottom: 10px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 5px; background: var(--primary); color: white; }
        .emoji { font-size: 6rem; display: block; margin: 10px 0; }
        .timer-box { font-size: 4rem; font-weight: 900; font-family: monospace; }
        
        /* æ¨¡æ…‹æ¡† */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .grade-grid { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
        .grade-card { background: white; padding: 20px; border-radius: 20px; width: 200px; text-align: center; cursor: pointer; color: #333; }

        @media (max-width: 1024px) { .layout { flex-direction: column; } .sidebar, .queue-panel { width: 100%; } }
    </style>
</head>
<body>

    <div id="status-bar">æ­£åœ¨æœå°‹ iPad ä¸Šçš„å¤§é™¸æ™®é€šè©±èªéŸ³...</div>

    <div class="modal" id="gradeModal">
        <h1 style="color:white;">ğŸ¦ é«”è‚²èª² (å¼·åˆ¶å¤§é™¸æ™®é€šè©±ç‰ˆ)</h1>
        
        <div style="margin: 30px 0;">
             <button onclick="forceUnlock()" style="padding:15px 30px; font-size:1.3rem; background:#facc15; border:none; border-radius:50px; font-weight:bold; box-shadow: 0 0 20px rgba(250, 204, 21, 0.5); cursor: pointer;">
                ğŸ”Š é»æˆ‘æ¸¬è©¦è²éŸ³ (å¿…é ˆé»æ“Š)
             </button>
        </div>
        <p style="color:#eee; font-size: 1.1rem;">è«‹å…ˆé»æ“Šé»ƒè‰²æŒ‰éˆ•ï¼Œè½åˆ°ã€Œæ¸¬è©¦æˆåŠŸã€å¾Œå†é¸å¹´ç´š</p>

        <div class="grade-grid">
            <div class="grade-card" onclick="selectGrade('kids')">ğŸ£ P1-P3 (åˆå°)</div>
            <div class="grade-card" onclick="selectGrade('junior')">ğŸƒ P4-P6 (é«˜å°)</div>
            <div class="grade-card" onclick="selectGrade('teen')">ğŸ… S1-S6 (ä¸­å­¸)</div>
        </div>
    </div>

    <div id="appContainer" style="display: none; height: 100%; flex-direction: column;">
        <nav class="navbar">
            <button class="nav-btn" onclick="location.reload()">â†©ï¸ é‡æ•´</button>
            <div style="font-weight:900;">é«”è‚²èª²</div>
        </nav>

        <div class="layout">
            <aside class="sidebar panel">
                <h3>è¨­å®š</h3>
                <label>å‹•ä½œæ•¸é‡</label>
                <select id="exCount"><option value="6">6 å€‹</option><option value="8">8 å€‹</option></select>
                <label>ç¸½æ™‚é•· (åˆ†é˜)</label>
                <select id="totalDuration" onchange="updateEstimates()"><option value="3">3 åˆ†é˜</option><option value="5" selected>5 åˆ†é˜</option></select>
                <div style="font-size:0.8rem; margin-bottom:10px;" id="timeEst"></div>
                
                <h3>éŸ³æ¨‚</h3>
                <select id="musicPreset" onchange="changeMusic()">
                    <option value="default">é è¨­ House</option>
                    <option value="happy">é–‹å¿ƒ Ukulele</option>
                    <option value="none">ä¸æ’­æ”¾éŸ³æ¨‚</option>
                </select>

                <button class="btn" id="startBtn" onclick="startWorkout()">ğŸš€ é–‹å§‹è¨“ç·´</button>
                <button class="btn" id="pauseBtn" onclick="togglePause()" disabled style="background:#999;">æš«åœ</button>
            </aside>

            <main class="main-stage">
                <div style="font-size:1.5rem; font-weight:bold; color:var(--primary);" id="phaseText">READY</div>
                <div class="emoji" id="mainIcon">ğŸ§˜</div>
                <div class="timer-box" id="timerDisplay">00:00</div>
                <h2 id="exName">æº–å‚™é–‹å§‹</h2>
                <p id="exDesc" style="padding:10px; background:rgba(255,255,255,0.5); border-radius:10px;">è«‹èª¿æ•´éŸ³é‡ä¸¦ç¢ºèªé—œé–‰éœéŸ³æ¨¡å¼</p>
            </main>
            
            <aside class="queue-panel panel">
                <ul id="queueList" style="list-style:none;"></ul>
            </aside>
        </div>
    </div>

    <audio id="bgm" loop playsinline></audio>

    <script>
        // --- 1. è³‡æ–™åº« (ç°¡åŒ–ç¯„ä¾‹ï¼Œå¯æ›¿æ›å›æ‚¨çš„å®Œæ•´è³‡æ–™) ---
        const db = {
            kids: [
                {name: "å¤§é¢¨è»Šè½‰è½‰", desc: "é›™è‡‚ä¼¸ç›´å‘å‰ç•«å¤§åœ“åœˆ", icon: "ğŸŒ¬ï¸"},
                {name: "é•·é ¸é¹¿æ‘˜è˜‹æœ", desc: "è¸®èµ·è…³å°–ç›¡åŠ›å‘ä¸Šä¼¸ç›´", icon: "ğŸ¦’"},
                {name: "æ©Ÿå™¨äººæ•¬ç¦®", desc: "æ‰‹è‡‚åƒµç¡¬åœ°å½æ›²ä¼¸ç›´", icon: "ğŸ¤–"},
                {name: "å°é³¥æ‹æ‹ç¿…", desc: "åƒç¿…è†€ä¸€æ¨£ä¸Šä¸‹æ‹å‹•", icon: "ğŸ¦"},
                {name: "å¤§çŒ©çŒ©æ¥èƒ¸", desc: "è¼•è¼•äº¤æ›¿æ‹æ‰“èƒ¸å£", icon: "ğŸ¦"},
                {name: "æ˜Ÿæ˜Ÿè·³", desc: "è·³èµ·æ™‚æ‰‹è…³å¤§å¼µåƒæ˜Ÿæ˜Ÿ", icon: "â­"}
            ],
            junior: [
                {name: "é–‹åˆè·³", desc: "é›™æ‰‹é ­é ‚æ“ŠæŒï¼Œé›™è…³è·³é–‹", icon: "ğŸ¤¸"},
                {name: "é«˜æŠ¬è…¿", desc: "å¤§è…¿æŠ¬é«˜è‡³æ°´å¹³", icon: "ğŸƒ"},
                {name: "æ·±è¹²", desc: "è‡€éƒ¨å‘å¾Œåï¼ŒèƒŒéƒ¨æŒºç›´", icon: "ğŸª‘"},
                {name: "æ³¢æ¯”è·³", desc: "è¹²ä¸‹å¾Œè·³ï¼Œå…¨èº«é‹å‹•", icon: "ğŸ’¥"},
                {name: "ç™»å±±è€…", desc: "ä¼åœ°æŒºèº«å§¿å‹¢ï¼Œè†è“‹è¡åˆº", icon: "ğŸ§—"},
                {name: "å¹³æ¿æ”¯æ’", desc: "æ‰‹è‚˜æ’åœ°ï¼Œè…¹éƒ¨æ”¶ç·Š", icon: "ğŸªµ"}
            ],
            teen: [
                {name: "æ³¢æ¯”è·³", desc: "æ·±è¹²ä¼åœ°æŒºèº«è·³èµ·", icon: "ğŸ’¥"},
                {name: "æ·±è¹²è·³", desc: "æ·±è¹²å¾Œç”¨åŠ›å‘ä¸Šè·³", icon: "ğŸš€"},
                {name: "åˆ†è…¿è¹²", desc: "å‰å¾Œè…³ç«™ç«‹ä¸‹è¹²", icon: "ğŸ‹ï¸"},
                {name: "ä¼åœ°æŒºèº«", desc: "èƒ¸å£è²¼è¿‘åœ°é¢å†æ¨èµ·", icon: "ğŸ’ª"},
                {name: "ä¿„ç¾…æ–¯è½‰é«”", desc: "åå§¿å·¦å³è½‰å‹•è…°éƒ¨", icon: "ğŸ‡·ğŸ‡º"},
                {name: "ç™»å±±è€…è¡åˆº", desc: "å¿«é€Ÿäº¤æ›¿æè†", icon: "ğŸƒ"}
            ]
        };

        const musicUrls = {
            default: "https://cdn.pixabay.com/download/audio/2022/03/15/audio_24a2752176.mp3",
            happy: "https://cdn.pixabay.com/download/audio/2022/01/18/audio_d0a13f69d2.mp3",
            none: ""
        };

        // --- 2. æ ¸å¿ƒè®Šæ•¸ ---
        let queue = [];
        let timer = 0;
        let interval;
        let isPaused = false;
        let phase = 'IDLE'; 
        let voiceObj = null; 
        let currentGrade = 'kids';

        const statusBar = document.getElementById('status-bar');
        const bgm = document.getElementById('bgm');

        // --- 3. èªéŸ³ç³»çµ± (é‡å°æ‚¨çš„ "ä¸­æ–‡(ä¸­åœ‹å¤§é™¸)" é€²è¡Œè¨­å®š) ---
        function initVoiceSystem() {
            const voices = window.speechSynthesis.getVoices();
            
            if (voices.length === 0) {
                // æœ‰æ™‚å€™ iPad éœ€è¦ä¸€é»æ™‚é–“è¼‰å…¥ï¼Œé€™è£¡å…ˆä¸å ±éŒ¯
                return;
            }

            // ğŸ” æœå°‹ç­–ç•¥ï¼šå„ªå…ˆæ‰¾ zh-CN (ä¸­åœ‹å¤§é™¸)
            // iPad ä¸Šå¸¸è¦‹åç¨±ï¼šLiLi, TianTian, Yu-shu, PingFang SC
            voiceObj = voices.find(v => v.lang === 'zh-CN') || 
                       voices.find(v => v.name.includes('China')) ||
                       voices.find(v => v.name.includes('Mainland')) ||
                       voices.find(v => v.lang.indexOf('zh') > -1); // åªè¦æ˜¯ä¸­æ–‡éƒ½è¡Œ

            if (voiceObj) {
                statusBar.innerText = `âœ… æˆåŠŸé–å®šèªéŸ³ï¼š${voiceObj.name} (${voiceObj.lang})`;
                statusBar.style.background = "#10b981"; // ç¶ è‰²
            } else {
                statusBar.innerText = "âš ï¸ æ‰¾ä¸åˆ°ä¸­æ–‡(ä¸­åœ‹å¤§é™¸)èªéŸ³ï¼Œå°‡å˜—è©¦ç³»çµ±é è¨­å€¼";
            }
        }

        // ç›£è½ iPad èªéŸ³è¼‰å…¥äº‹ä»¶
        window.speechSynthesis.onvoiceschanged = initVoiceSystem;
        // ç‚ºäº†ä¿éšªï¼Œæ¯ 0.5 ç§’æª¢æŸ¥ä¸€æ¬¡ï¼Œç›´åˆ°æ‰¾åˆ°ç‚ºæ­¢
        let initCheck = setInterval(() => {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
                initVoiceSystem();
                clearInterval(initCheck);
            }
        }, 500);


        function speak(text) {
            window.speechSynthesis.cancel(); // æ–·é–‹ä¸Šä¸€å¥
            const u = new SpeechSynthesisUtterance(text);
            u.rate = 1.0;
            
            if (voiceObj) {
                u.voice = voiceObj;
                u.lang = voiceObj.lang; // ç¢ºä¿è¨­ç½®ç‚º zh-CN
            } else {
                u.lang = 'zh-CN'; // å¼·åˆ¶è¨­å®šèªè¨€æ¨™ç±¤
            }
            
            // iPad æ’­æ”¾æŠ€å·§ï¼šç‚ºäº†ä¸è®“èƒŒæ™¯éŸ³æ¨‚å®Œå…¨è“‹éèªéŸ³
            bgm.volume = 0.2; 
            u.onend = () => { bgm.volume = 0.5; };
            
            window.speechSynthesis.speak(u);
        }

        // --- 4. äº’å‹•é‚è¼¯ ---
        function forceUnlock() {
            // å¼·åˆ¶æ¸¬è©¦ï¼šèªªé€™å¥è©±
            if (window.speechSynthesis) {
                const u = new SpeechSynthesisUtterance("æ¸¬è©¦æˆåŠŸï¼Œè²éŸ³æ­£å¸¸");
                u.lang = 'zh-CN'; // å¼·åˆ¶å¤§é™¸æ™®é€šè©±
                if(voiceObj) u.voice = voiceObj;
                window.speechSynthesis.speak(u);
            }
            // å¼·åˆ¶è§£é–éŸ³æ¨‚
            bgm.play().then(() => bgm.pause()).catch(e => console.log(e));
            
            alert("è«‹è½æ˜¯å¦æœ‰è²éŸ³ï¼Ÿ\n\nå¦‚æœæ²’æœ‰ï¼š\n1. è«‹æª¢æŸ¥ iPad å´é‚Šæ˜¯å¦æœ‰é–‹é—œåˆ‡åˆ°ç´…è‰²ã€‚\n2. è¢å¹•å³ä¸Šè§’ä¸‹æ»‘ï¼Œç¢ºèªéˆ´éºåœ–ç¤ºæ²’æœ‰è¢«åŠƒæ‰ã€‚");
        }

        function selectGrade(grade) {
            currentGrade = grade;
            document.body.className = `theme-${grade}`;
            document.getElementById('gradeModal').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            
            speak("æ­¡è¿ä½¿ç”¨ï¼Œè«‹æº–å‚™é–‹å§‹");
            updateEstimates();
            changeMusic();
        }

        function updateEstimates() {
            const count = parseInt(document.getElementById('exCount').value);
            const totalMin = parseInt(document.getElementById('totalDuration').value);
            const totalSec = totalMin * 60;
            const cycleTime = Math.floor(totalSec / count);
            const work = Math.floor(cycleTime * 0.65);
            const rest = cycleTime - work - 5; 
            document.getElementById('timeEst').innerText = `æ¯å‹•ä½œ: é å‚™5s / é‹å‹•${work}s / ä¼‘æ¯${rest}s`;
            return { work, rest };
        }

        function generateQueue() {
            const count = parseInt(document.getElementById('exCount').value);
            let list = [...db[currentGrade]].sort(()=>0.5-Math.random()).slice(0, count);
            const ul = document.getElementById('queueList');
            ul.innerHTML = "";
            list.forEach((item, i) => {
                ul.innerHTML += `<li style="padding:10px; border-bottom:1px solid rgba(0,0,0,0.1); display:flex; gap:10px;">
                    <b>${i+1}.</b> <span>${item.name}</span>
                </li>`;
            });
            return list;
        }

        function startWorkout() {
            queue = generateQueue();
            const { work, rest } = updateEstimates();
            
            if(document.getElementById('musicPreset').value !== 'none') {
                bgm.play().catch(() => statusBar.innerText = "âš ï¸ éŸ³æ¨‚è¢«æ””æˆªï¼Œè«‹å†æ¬¡é»æ“Š");
            }

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('pauseBtn').style.background = '#f59e0b';
            
            let qIndex = 0;
            
            function runPhase(pName, duration, item) {
                phase = pName;
                timer = duration;
                updateDisplay(item);
                
                // èªéŸ³æ’­å ± (å¼·åˆ¶æ™®é€šè©±)
                if (pName === 'READY') speak(`ä¸‹ä¸€å€‹å‹•ä½œï¼š${item.name}ã€‚${item.desc}`);
                if (pName === 'WORK') speak(`é–‹å§‹ï¼${item.name}`);
                if (pName === 'REST') speak("ä¼‘æ¯æ™‚é–“");

                clearInterval(interval);
                interval = setInterval(() => {
                    if(isPaused) return;
                    
                    timer--;
                    let m = Math.floor(timer/60).toString().padStart(2,'0');
                    let s = (timer%60).toString().padStart(2,'0');
                    document.getElementById('timerDisplay').innerText = `${m}:${s}`;

                    if (pName === 'WORK' && timer <= 3 && timer > 0) speak(timer.toString());

                    if (timer <= 0) {
                        if (pName === 'READY') runPhase('WORK', work, item);
                        else if (pName === 'WORK') runPhase('REST', rest, item);
                        else if (pName === 'REST') {
                            qIndex++;
                            if (qIndex < queue.length) {
                                runPhase('READY', 5, queue[qIndex]);
                            } else {
                                finish();
                            }
                        }
                    }
                }, 1000);
            }

            runPhase('READY', 5, queue[0]);
        }

        function updateDisplay(item) {
            document.getElementById('phaseText').innerText = phase;
            if (phase === 'REST') {
                document.getElementById('mainIcon').innerText = "ğŸ¥¤";
                document.getElementById('exName').innerText = "ä¼‘æ¯æ™‚é–“";
                document.getElementById('exDesc').innerText = "èª¿æ•´å‘¼å¸";
                document.body.style.background = "#e5e7eb";
            } else {
                document.getElementById('mainIcon').innerText = item.icon;
                document.getElementById('exName').innerText = item.name;
                document.getElementById('exDesc').innerText = item.desc;
                if (phase === 'WORK') document.body.style.background = "#ffe4e6"; 
                else document.body.style.background = "var(--bg-grad)";
            }
        }

        function finish() {
            clearInterval(interval);
            bgm.pause();
            speak("è¨“ç·´å®Œæˆ");
            document.getElementById('phaseText').innerText = "DONE";
            document.getElementById('mainIcon').innerText = "ğŸ‰";
            document.getElementById('exName').innerText = "è¨“ç·´çµæŸ";
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('startBtn').innerText = "å†åšä¸€æ¬¡";
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('pauseBtn').style.background = '#999';
        }

        function changeMusic() {
            const val = document.getElementById('musicPreset').value;
            bgm.src = musicUrls[val];
        }

        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('pauseBtn');
            btn.innerText = isPaused ? "ç¹¼çºŒ" : "æš«åœ";
            if (isPaused) {
                bgm.pause();
                window.speechSynthesis.pause();
            } else {
                bgm.play();
                window.speechSynthesis.resume();
            }
        }
    </script>
</body>
</html>
